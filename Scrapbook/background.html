<html>
  <head>
    <script type="text/javascript" src="js/jquery-1.4.2.min.js"></script>


	<script type="text/javascript" src="sbstorage.js"></script>
	<script type="text/javascript" src="frontend.js"></script>
	<script type="text/javascript" src="background.js"></script>
	<script>
		SBookInterface =function(params){
			this.sBookInterfaceData ={
				dbName : params.dbName,
				dispName : params.dbName,
				dbSize : params.dbSize,
				dbVersion : params.dbVersion
			}
		}
		window.isPending = false;
		flag1 = false;//This is a protector against sending the CS data every time.
		dataToRender = {};
		saveSoonParams = null;
		cachedAnnotationData = null;
		cachedNotesData = null;
		//TO DO:Initilaization logic with the rendering module to display all the messages.
		//Change the window.sbookInterface from the options page. 
		//A default 500 MB scrapbook initiaited at the start of the program.
		var defaultParams =  {dbName:'DefaultSbook' ,dbVersion:1.0, dbSize:5000*1024*1024 }
		window.sbookInterface = new SBookInterface(defaultParams);
		
		/*Call this from options page to change the scrapbook a v1.1 feature*/
		function setScrapBook(params){
			window.sbookInterface = new SBookInterface(param);
			
		}
		window.bookFE = new scrapBookFrontEnd({
			placeholder:'messages',folderPlaceHolder :  'foldermenu', sbookPlaceHolder : 'sbookmenu' ,  
			dbName:sbookInterface.sBookInterfaceData.dbName ,dbVersion:sbookInterface.sBookInterfaceData.dbVersion,
			dbSize:sbookInterface.sBookInterfaceData.dbSize 
		});
		function initBook(){
			
			//TODO: initialize the configuration also
			createTables();
			
		}
	
	
		//This is to set URL of pages we open from the web only...
		chrome.tabs.onCreated.addListener(function(tab) {
			
			console.log('new page opened.');
			
			var s = /http|https|file:\/\//;
			
			if(tab.url && s.test(tab.url)){
				 chrome.tabs.sendRequest(tab.id, {requestType:"setpageproperty", propName: 'url', propValue:tab.url}, function(response) {
					 //snub it
				 })
			}
			
		})
		
		
		//send in the data to render on the newly opened page
		chrome.extension.onRequest.addListener(
			function(request, sender, sendResponse) {
			
			if (sender.tab  && request.requestType ==  'downloadFile'){
				console.log('Downloading file...')
				handleDownloadFile(request, sendResponse);
			}
			if (sender.tab && request.requestType ==  'deletePages'){
				console.log('Deleteing file...')
				deletePagesDB(request, function(retParams){
					console.log('Deleted some files:');
					console.log(retParams.pageids);
					flushPageMenuCache();
					sendResponse(retParams);
					},function(error){
						
						window.sbnotification = webkitNotifications.createNotification(
							  'images/scrap48.jpg',  
							  'Scrapbook',  
							  'Error while deleting pages: '+error.message  // notification body text
						);
						window.sbnotification.show();
						setTimeout('window.sbnotification.cancel()',3000)
						
					});
			}
			if(sender.tab && request.requestType =='getSBPageList'){
				
				getDataForOptionsPageDB(function(data){
						params = {}
						for(i = 0;i<data.rows.length;i++){
							params[i] = {pageid: data.rows.item(i).pageid, title: data.rows.item(i).nickname, foldername:data.rows.item(i).foldername, url: data.rows.item(i).url };
							
						}
						sendResponse({data:params})
				}, function(error){
					
					 window.sbnotification = webkitNotifications.createNotification(
							  'images/scrap128.png',  
							  'Scrapbook',  
							  'Error while managing scrapbook: '+error.message  // notification body text
					);
					window.sbnotification.show();
					setTimeout('window.sbnotification.cancel()',3000)
				})
				//sendResponse('hello world!');
			}
			if (sender.tab  && request.requestType == "savepage"){
				//save the annotations on this page...
				console.log('Saving page...')
				saveAnnotationsOnPage(sendResponse, request.params);
			}
			/*Automatic saving of the web page..*/
			if (sender.tab  && request.requestType == "savesoon"){
				console.log('Marked for saving: '+request.params)
				window.saveSoonParams = request.params;				
			}
			if(sender.tab  && request.requestType == "scrappedpage"){
			
			    var params = request;
				
				//Check for the oldpage
				//save if page is new
				if(request.status=='OK' && !params.isold ){
					console.log('Saving new page');
					//TO DO: Delegate heavy tasks to web workers...
					try{
					saveNewPageDB(params, function(params){
							var popup = chrome.extension.getViews({type:'popup'})[0];
							console.log('Updating cache...');
							//Dont redo cache. Just update it.
							console.log(window.sbookDDHTML);
							console.log('Folder  ID:'+params.folderid);
							console.log('pageID: '+params.pageid);
							//console.log($(sbookDDHTML).find('li[folderid='+params.folderid+']>ul')[0])
							/*
							* 
							if(params.folderid!=-1){
								
								sbookDDHTML = $(sbookDDHTML).find('li[folderid='+params.folderid+']>ul').append("<li rel='p"+retparams.pageid+"' pageid= '"+retparams.pageid+"' >"+params.title+"</li>").parents('#sbookmenu')[0].outerHTML;
								//$(sbookDDHTML).find("li[rel='p"+retparams.pageid+"']").bind('click',{pageID:retparams.pageid, pageName:params.title},selectedPage);

							}else{
								sbookDDHTML = $(sbookDDHTML).append("<li rel='p"+retparams.pageid+"' pageid= '"+retparams.pageid+"' >"+params.title+"</li>").outerHTML;
								//$(sbookDDHTML).find("li[rel='p"+retparams.pageid+"']").bind('click',{pageID:retparams.pageid, pageName:params.title},selectedPage);

							}*/
							
							//console.log(sbookDDHTML)
							//TO DO: push heavy task to web workers...
							flushPageMenuCache();
							if(popup){
							//Redo all cache...	
								popup.bookFE.renderFullBook(function(){
									console.log('Rendered page menu');
									$(popup.document).find('#sbsavepagetext').empty()
								    $(popup.document).find('#sbsavepagetext').remove()
									
									//popup.bookFE.callback({status:'OK', message:'Saved new page', code:1});
									window.isPending  = false;
								});
								
							}
							window.sbnotification = webkitNotifications.createNotification(
									  'images/scrap128.png',  // icon url - can be relative
									  'Scrapbook',  // notification title
									  'Page scrapped.'  // notification body text
							);
							window.sbnotification.show();
							setTimeout('window.sbnotification.cancel()',3000)
							window.isPending  = false;
						
						} , function(error){
								console.log(error.message);
								window.isPending  = false;//Release lock...
						});
					}catch(err){
						window.isPending  = false;
					}
				
				}
				else if(request.status=='OK' && params.isold){
					
						console.log('Overwriting page...');
						try{
						overwritePageDB(params, function(message){
							//Dont redo the cache 
							
							var popup = chrome.extension.getViews({type:'popup'})[0];
							if(popup){
								console.log(message);
								//popup.initFEObject();
								
								$(popup.document).find('#sbsavepagetext').empty()
								$(popup.document).find('#sbsavepagetext').remove()
							
							}
							window.sbnotification = webkitNotifications.createNotification(
									  'images/scrap128.png',  // icon url - can be relative
									  'Scrapbook',  // notification title
									  'Page scrapped.'  // notification body text
								);
							window.sbnotification.show();
							setTimeout('window.sbnotification.cancel()',3000);
							
							window.isPending  = false;	
							} ,function(error){
								console.log(error.message);
								window.isPending  = false;
							})
						}catch(err){
							window.isPending  = false;
						}
					
				}else{
					console.log(request.message);
				}			
			//Unrecognized request...			
			}else{
				
				console.log(request.message);
			}
			console.log('Got request type:'+ request.requestType)
		//End of addlistener		
		});
		  
		
		
		</script>
    <body onload = 'initBook()'>
    </body>
  </head>
</html>
